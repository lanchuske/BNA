<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Unidades Organizativas BNA</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .section { margin-top: 2em; }
        .title { font-size: 2em; font-weight: bold; margin-bottom: 0.2em; }
        .info-line { margin-bottom: 0.2em; }
        .info-label { font-weight: bold; }
        .mission-label { font-weight: bold; margin-top: 1em; }
        .mission-box { margin-bottom: 1.5em; }
        .func-table { border-collapse: collapse; width: 100%; margin-top: 1em; margin-bottom: 1.5em; }
        .func-table th, .func-table td { border: 1px solid #bfc9d1; padding: 0.6em 0.5em; }
        .func-table th { background: #e0eaf3; font-weight: bold; }
        .func-table tr:nth-child(even) { background: #f8f9fa; }
        .func-section-title { font-weight: bold; font-size: 1.1em; margin-top: 1.5em; margin-bottom: 0.2em; }
        #fileInput { margin: 20px 0; }
        .tree { margin-bottom: 2em; }
        .tree ul { padding-left: 20px; border-left: 1px solid #ccc; margin: 0; }
        .tree li { list-style-type: none; margin: 0; padding: 0.2em 0 0.2em 1em; position: relative; }
        .tree li::before { content: ''; position: absolute; left: 0; top: 1.2em; width: 1em; height: 0; border-top: 1px solid #ccc; }
        .tree span.node { cursor: pointer; display: inline-block; padding: 2px 8px; border-radius: 4px; transition: background 0.2s, color 0.2s; }
        .tree span.node.selected, .tree span.node:hover { background: #3498db; color: #fff; }
        .tree .toggle { cursor: pointer; font-size: 13px; color: #3498db; margin-right: 4px; user-select: none; }
        .edit-btn, .export-btn { margin: 0 0.5em 1em 0; padding: 0.5em 1.2em; font-size: 1em; border-radius: 4px; border: 1px solid #3498db; background: #e0eaf3; color: #222; cursor: pointer; transition: background 0.2s; }
        .edit-btn.active { background: #3498db; color: #fff; }
        .export-btn { border: 1px solid #2ecc71; background: #eafaf1; color: #222; }
        .export-btn:hover { background: #2ecc71; color: #fff; }
        .edit-btn:hover { background: #3498db; color: #fff; }
        .delete-func { color: #c0392b; cursor: pointer; font-weight: bold; margin-left: 0.5em; }
        .add-func { color: #27ae60; cursor: pointer; font-weight: bold; margin-left: 0.5em; }
        input, select, textarea { font-size: 1em; padding: 0.2em; border-radius: 3px; border: 1px solid #bfc9d1; }
        textarea { resize: vertical; }
        /* Nuevos estilos para el indicador de guardado */
        .save-indicator { 
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            background: #2ecc71;
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        .save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <h1 style="display:inline-block;">Unidades Organizativas BNA</h1>
    <div style="position:absolute;top:2em;right:2em;z-index:10;">
      <div style="position:relative;display:inline-block;">
        <button id="adminBtn" class="edit-btn" style="background:#3498db;color:#fff;">Admin ▼</button>
        <div id="adminMenu" style="display:none;position:absolute;right:0;top:2.5em;background:#fff;border:1px solid #bfc9d1;border-radius:6px;box-shadow:0 2px 8px #0001;padding:1em 1.2em;min-width:220px;">
          <div style="margin-bottom:1em;">
            <label style="font-weight:bold;">Cargar CSV:<br><input type="file" id="fileInput" accept=".csv"></label>
          </div>
          <button id="editModeBtn" class="edit-btn" style="width:100%;margin-bottom:0.7em;">Entrar en modo edición</button>
          <button id="exportBtn" class="export-btn" style="width:100%;display:none;">Exportar CSV</button>
        </div>
      </div>
    </div>
    <div id="saveIndicator" class="save-indicator">Cambios guardados</div>
    <div id="tree-container" class="tree"></div>
    <div id="unidad-content" class="section"></div>
    <script>
    let unidadesMap = {};
    let treeRoots = [];
    let lastSelected = '';
    let expandedNodes = {};
    let editMode = false;
    let allUnidades = [];
    let csvHeaders = [];
    let inconsistenciaDetectada = false;
    let originalCSV = '';
    let datosModificados = false;



    function marcarAdminCambios(pendiente) {
      const adminBtn = document.getElementById('adminBtn');
      if (pendiente) {
        adminBtn.style.background = '#e67e22'; // naranja
        adminBtn.title = '¡Hay cambios sin exportar! Haz clic para exportar.';
      } else {
        adminBtn.style.background = '#3498db';
        adminBtn.title = '';
      }
    }

    function compararCSVActualConOriginal() {
      if (!csvHeaders || csvHeaders.length === 0) {
        console.warn('csvHeaders no definido, no se pueden guardar cambios');
        return;
      }
      
      try {
        // Generar CSV actual
        let rows = [csvHeaders.join(';')];
        Object.values(unidadesMap).forEach(arr => {
          arr.forEach(u => {
            let row = csvHeaders.map(h => (u[h] || '').toString().trim());
            rows.push(row.join(';'));
          });
        });
        const actual = rows.join('\n');
        
        // Verificar si hay cambios
        datosModificados = (actual !== originalCSV);
        marcarAdminCambios(datosModificados);
        
        // Guardar automáticamente en localStorage si hay cambios
        if (datosModificados && editMode) {
          try {
            localStorage.setItem('csvData', actual);
            localStorage.setItem('csvLastSaved', new Date().toISOString());
            console.log('Cambios guardados automáticamente en localStorage:', new Date().toLocaleString());
            
            // Mostrar mensaje sutil de guardado automático
            mostrarAlerta('Cambios guardados automáticamente', 1000, '#27ae60');
            
            // Actualizar originalCSV para futuras comparaciones
            originalCSV = actual;
          } catch (e) {
            console.error('Error al guardar en localStorage:', e);
            mostrarAlerta('Error al guardar cambios', 2000, '#e74c3c');
          }
        }
      } catch (e) {
        console.error('Error al comparar/guardar cambios:', e);
        mostrarAlerta('Error al procesar cambios', 2000, '#e74c3c');
      }
    }

    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(Boolean);
      const headers = lines[0].split(';');
      csvHeaders = headers;
      return lines.slice(1).map(line => {
        const values = line.split(';');
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = (values[i] || '').trim());
        return obj;
      });
    }
    function groupByUnidad(data) {
      const map = {};
      data.forEach(item => {
        // Usar clave compuesta: nombre + '|' + reportaA
        const key = item['Unidad Organizativa'] + '|' + (item['Reporta A'] || '');
        if (!map[key]) map[key] = [];
        map[key].push(item);
      });
      return map;
    }
    function buildTree(data) {
      const nodeMap = {};
      data.forEach(item => {
        const name = item['Unidad Organizativa'];
        const parent = item['Reporta A'] || '';
        const key = name + '|' + parent;
        if (!nodeMap[key]) nodeMap[key] = { key, name, parent, children: [], item };
        nodeMap[key].parent = parent;
      });
      // Relacionar hijos con padres usando la clave compuesta
      Object.values(nodeMap).forEach(node => {
        if (node.parent) {
          // Buscar clave del padre
          const parentKey = Object.keys(nodeMap).find(k => nodeMap[k].name === node.parent);
          if (parentKey && nodeMap[parentKey]) {
            nodeMap[parentKey].children.push(node);
          }
        }
      });
      // Raíces: nodos cuyo padre no existe en el mapa
      const roots = Object.values(nodeMap).filter(node => {
        const parentKey = Object.keys(nodeMap).find(k => nodeMap[k].name === node.parent);
        return !node.parent || !parentKey;
      });
      return roots;
    }
    function renderTree(nodes, parentElem, selectUnidad, selectedKey) {
      if (!nodes.length) return;
      const ul = document.createElement('ul');
      nodes.forEach(node => {
        const li = document.createElement('li');
        // Botón agregar/eliminar solo en modo edición
        if (editMode) {
          const addBtn = document.createElement('span');
          addBtn.textContent = ' ＋ ';
          addBtn.className = 'add-func';
          addBtn.title = 'Agregar subunidad';
          addBtn.onclick = function(e) {
            e.stopPropagation();
            const nombre = prompt('Nombre de la nueva unidad organizativa:');
            if (!nombre) return;
            // Validar duplicados exactos (nombre + reporta a)
            let existeMisma = false;
            let existeNombreOtroReporta = false;
            Object.keys(unidadesMap).forEach(k => {
              const arr = unidadesMap[k];
              arr.forEach(u => {
                if (u['Unidad Organizativa'] === nombre && u['Reporta A'] === node.name) existeMisma = true;
                else if (u['Unidad Organizativa'] === nombre && u['Reporta A'] !== node.name) existeNombreOtroReporta = true;
              });
            });
            if (existeMisma) {
              alert('Ya existe una unidad con ese nombre que reporta a esta área. No se puede duplicar.');
              return;
            }
            if (existeNombreOtroReporta) {
              if (!confirm('Ya existe una unidad con ese nombre, pero reporta a otra área. ¿Desea crearla igualmente?')) return;
            }
            // Crear nueva unidad con valores mínimos
            const nueva = {
              'Unidad Organizativa': nombre,
              'Reporta A': node.name,
              'Jerarquía': '',
              'Nivel Jerárquico Calculado': '',
              'Unidades que Reportan Directamente': '',
              'Misión': '',
              'Tipo de Función': 'Genérica',
              'Descripción': '',
              'Producto Final': ''
            };
            const newKey = nombre + '|' + node.name;
            unidadesMap[newKey] = [nueva];
            allUnidades = Object.keys(unidadesMap).map(k => unidadesMap[k][0]['Unidad Organizativa']);
            treeRoots = buildTree([].concat(...Object.values(unidadesMap)));
            renderTree(treeRoots, document.getElementById('tree-container'), selectUnidad, newKey);
            selectUnidad(newKey);
            compararCSVActualConOriginal && compararCSVActualConOriginal();
          };
          li.appendChild(addBtn);
          if (node.parent) {
            const delBtn = document.createElement('span');
            delBtn.textContent = '✕';
            delBtn.className = 'delete-func';
            delBtn.title = 'Eliminar unidad';
            delBtn.onclick = function(e) {
              e.stopPropagation();
              delete unidadesMap[node.key];
              allUnidades = Object.keys(unidadesMap).map(k => unidadesMap[k][0]['Unidad Organizativa']);
              treeRoots = buildTree([].concat(...Object.values(unidadesMap)));
              renderTree(treeRoots, document.getElementById('tree-container'), selectUnidad, '');
              document.getElementById('unidad-content').innerHTML = '';
              compararCSVActualConOriginal && compararCSVActualConOriginal();
            };
            li.appendChild(delBtn);
          }
        }
        if (node.children.length) {
          const toggle = document.createElement('span');
          toggle.className = 'toggle';
          toggle.textContent = expandedNodes[node.key] ? '[–]' : '[+]';
          toggle.onclick = function(e) {
            e.stopPropagation();
            expandedNodes[node.key] = !expandedNodes[node.key];
            const treeDiv = document.getElementById('tree-container');
            treeDiv.innerHTML = '';
            renderTree(treeRoots, treeDiv, selectUnidad, lastSelected);
          };
          li.appendChild(toggle);
        } else {
          const empty = document.createElement('span');
          empty.className = 'toggle';
          empty.textContent = '   ';
          li.appendChild(empty);
        }
        const span = document.createElement('span');
        span.textContent = node.name;
        span.className = 'node' + (node.key === selectedKey ? ' selected' : '');
        span.onclick = function(e) {
          e.stopPropagation();
          selectUnidad(node.key);
        };
        li.appendChild(span);
        if (node.children.length && expandedNodes[node.key]) {
          renderTree(node.children, li, selectUnidad, selectedKey);
        }
        ul.appendChild(li);
      });
      parentElem.appendChild(ul);
    }
    function correctSpelling(text) {
      // Simple autocorrect: capitalize first letter, trim, and fix double spaces
      if (!text) return '';
      let t = text.trim().replace(/\s+/g, ' ');
      return t.charAt(0).toUpperCase() + t.slice(1);
    }
    function showUnidad(unidadArr) {
      if (!unidadArr || !unidadArr.length) {
        document.getElementById('unidad-content').innerHTML = '';
        return;
      }
      const base = unidadArr[0];
      const genericas = unidadArr.filter(u => (u['Tipo de Función'] || '').toLowerCase().includes('gen'));
      const especificas = unidadArr.filter(u => (u['Tipo de Función'] || '').toLowerCase().includes('espec'));
      let html = '';
      if (!editMode) {
        html += `<div class="title">${base['Unidad Organizativa']}</div>`;
        html += `<div class="info-line"><span class="info-label">Reporta a:</span> ${base['Reporta A'] || 'Ninguno'}</div>`;
        html += `<div class="info-line"><span class="info-label">Jerarquía:</span> ${base['Jerarquía'] || ''}</div>`;
        html += `<div class="info-line"><span class="info-label">Nivel Jerárquico Calculado:</span> ${base['Nivel Jerárquico Calculado'] || ''}</div>`;
        html += `<div class="info-line"><span class="info-label">Unidades que Reportan Directamente:</span> ${base['Unidades que Reportan Directamente'] || ''}</div>`;
        html += `<div class="mission-label">Misión:</div><div class="mission-box">${base['Misión'] || ''}</div>`;
      } else {
        // Edición de campos principales
        html += `<div class="title"><input id="edit-nombre" value="${base['Unidad Organizativa']}" style="font-size:1.2em;width:60%"></div>`;
        // Select de áreas posibles para "Reporta a"
        html += `<div class="info-line"><span class="info-label">Reporta a:</span> <select id="edit-reporta">
          <option value="">Ninguno</option>`;
        allUnidades.slice().sort((a, b) => a.localeCompare(b, 'es', {sensitivity:'base'})).forEach(u => {
          if (u !== base['Unidad Organizativa']) {
            html += `<option value="${u}"${base['Reporta A'] === u ? ' selected' : ''}>${u}</option>`;
          }
        });
        html += `</select></div>`;
        html += `<div class="info-line"><span class="info-label">Jerarquía:</span> <input id="edit-jerarquia" value="${base['Jerarquía'] || ''}"></div>`;
        html += `<div class="info-line"><span class="info-label">Nivel Jerárquico Calculado:</span> <input id="edit-nivel" value="${base['Nivel Jerárquico Calculado'] || ''}"></div>`;
        let uqrdStyle = '';
        let uqrdTitle = '';
        if (base._autocompletado) {
          uqrdStyle += 'background: #fff8b3; border: 1.5px solid #e6b800;';
          uqrdTitle = 'Campo autocompletado automáticamente';
        }
        if (base._ambiguedad) {
          uqrdStyle += 'background: #ffd6d6; border: 2px solid #d32f2f;';
          uqrdTitle += ' (Hay unidades con el mismo nombre pero distinto padre. Revisa los datos)';
        }
        html += `<div class="info-line"><span class="info-label">Unidades que Reportan Directamente:</span> <input type="text" id="uqrd" value="${base['Unidades que Reportan Directamente'] || ''}" style="${uqrdStyle}" title="${uqrdTitle}"></div>`;
        html += `<div class="mission-label">Misión:</div><textarea id="edit-mision" rows="2" style="width:100%">${base['Misión'] || ''}</textarea>`;
      }
      // Funciones Genéricas
      html += `<div class="func-section-title">Funciones Genéricas`;
      if (editMode) html += `<span class="add-func" onclick="window.addFuncRow('gen')">+ Agregar</span>`;
      html += `</div>`;
      html += `<table class="func-table"><thead><tr><th>Descripción</th><th>Producto Final</th>${editMode ? '<th></th>' : ''}</tr></thead><tbody id="gen-func-tbody">`;
      genericas.forEach((u, idx) => {
        if (!editMode) {
          html += `<tr><td>${u['Descripción'] || ''}</td><td>${u['Producto Final'] || ''}</td></tr>`;
        } else {
          html += `<tr><td><textarea data-func-type="gen" data-idx="${idx}" data-field="Descripción" rows="2" style="width:98%">${u['Descripción'] || ''}</textarea></td><td><input data-func-type="gen" data-idx="${idx}" data-field="Producto Final" value="${u['Producto Final'] || ''}" style="width:98%"></td><td><span class="delete-func" onclick="window.deleteFuncRow('gen',${idx})">✕</span></td></tr>`;
        }
      });
      html += `</tbody></table>`;
      // Funciones Específicas
      html += `<div class="func-section-title">Funciones Específicas`;
      if (editMode) html += `<span class="add-func" onclick="window.addFuncRow('espec')">+ Agregar</span>`;
      html += `</div>`;
      html += `<table class="func-table"><thead><tr><th>Descripción</th><th>Producto Final</th><th>% Dedicación</th>${editMode ? '<th></th>' : ''}</tr></thead><tbody id="espec-func-tbody">`;
      especificas.forEach((u, idx) => {
        if (!editMode) {
          html += `<tr><td>${u['Descripción'] || ''}</td><td>${u['Producto Final'] || ''}</td><td>${u['Porcentaje Dedicación'] || ''}</td></tr>`;
        } else {
          html += `<tr><td><textarea data-func-type="espec" data-idx="${idx}" data-field="Descripción" rows="2" style="width:98%">${u['Descripción'] || ''}</textarea></td><td><input data-func-type="espec" data-idx="${idx}" data-field="Producto Final" value="${u['Producto Final'] || ''}" style="width:98%"></td><td><input data-func-type="espec" data-idx="${idx}" data-field="Porcentaje Dedicación" value="${u['Porcentaje Dedicación'] || ''}" style="width:90%"></td><td><span class="delete-func" onclick="window.deleteFuncRow('espec',${idx})">✕</span></td></tr>`;
        }
      });
      html += `</tbody></table>`;
      document.getElementById('unidad-content').innerHTML = html;
      if (editMode) attachEditHandlers(base, genericas, especificas);
    }
    function attachEditHandlers(base, genericas, especificas) {
      // Corrección ortográfica y actualización en blur/change
      document.querySelectorAll('#edit-nombre, #edit-jerarquia, #edit-nivel, #uqrd, #edit-mision').forEach(input => {
        // Evento input para guardado en tiempo real
        input.addEventListener('input', function() {
          const field = this.id.replace('edit-', '');
          const value = this.value.trim();
          
          // Actualizar el valor en todos los objetos de la unidad
          unidadesMap[lastSelected].forEach(u => {
            switch(field) {
              case 'nombre':
                if (value && value !== base['Unidad Organizativa']) {
                  const newKey = value + '|' + base['Reporta A'];
                  unidadesMap[newKey] = unidadesMap[lastSelected];
                  delete unidadesMap[lastSelected];
                  base['Unidad Organizativa'] = value;
                  lastSelected = newKey;
                  allUnidades = Object.keys(unidadesMap).map(k => unidadesMap[k][0]['Unidad Organizativa']);
                }
                break;
              case 'jerarquia':
                u['Jerarquía'] = value;
                break;
              case 'nivel':
                u['Nivel Jerárquico Calculado'] = value;
                break;
              case 'uqrd':
                u['Unidades que Reportan Directamente'] = value;
                break;
              case 'mision':
                u['Misión'] = value;
                break;
            }
          });
          
          // Guardar cambios
          if (editMode) {
            compararCSVActualConOriginal();
          }
        });

        // Corrección ortográfica en blur
        input.addEventListener('blur', function() {
          this.value = correctSpelling(this.value);
        });
      });

      // Manejar cambios en el select de "Reporta a"
      document.getElementById('edit-reporta').addEventListener('change', function() {
        const oldKey = base['Unidad Organizativa'] + '|' + (base['Reporta A'] || '');
        const newReporta = this.value;
        base['Reporta A'] = newReporta;
        const newKey = base['Unidad Organizativa'] + '|' + (newReporta || '');
        
        if (newKey !== oldKey) {
          unidadesMap[newKey] = unidadesMap[oldKey];
          delete unidadesMap[oldKey];
          unidadesMap[newKey].forEach(u => u['Reporta A'] = newReporta);
          lastSelected = newKey;
          allUnidades = Object.keys(unidadesMap).map(k => unidadesMap[k][0]['Unidad Organizativa']);
          treeRoots = buildTree([].concat(...Object.values(unidadesMap)));
          
          const treeDiv = document.getElementById('tree-container');
          treeDiv.innerHTML = '';
          renderTree(treeRoots, treeDiv, selectUnidad, lastSelected);
          showUnidad(unidadesMap[newKey]);
          
          if (editMode) {
            compararCSVActualConOriginal();
          }
        }
      });

      // Funciones - Agregar guardado automático
      document.querySelectorAll('textarea[data-func-type], input[data-func-type]').forEach(input => {
        input.addEventListener('input', function() {
          const type = this.getAttribute('data-func-type');
          const idx = parseInt(this.getAttribute('data-idx'));
          const field = this.getAttribute('data-field');
          
          if (type === 'gen') {
            genericas[idx][field] = this.value;
          } else if (type === 'espec') {
            especificas[idx][field] = this.value;
          }
          
          if (editMode) {
            compararCSVActualConOriginal();
          }
        });
        
        input.addEventListener('blur', function() {
          this.value = correctSpelling(this.value);
          compararCSVActualConOriginal();
        });
      });
    }
    function autocompletarUnidadesReportan() {
      // Mapear hijos por padre y contar ocurrencias por nombre
      const hijosPorPadre = {};
      const nombreCount = {};
      Object.values(unidadesMap).forEach(arr => {
        arr.forEach(u => {
          const padre = u['Reporta A'];
          const nombre = u['Unidad Organizativa'];
          if (padre) {
            if (!hijosPorPadre[padre]) hijosPorPadre[padre] = [];
            hijosPorPadre[padre].push({ nombre, padre });
          }
          // Contar ocurrencias globales
          if (!nombreCount[nombre]) nombreCount[nombre] = new Set();
          nombreCount[nombre].add(padre || '');
        });
      });
      // Autocompletar campo si está vacío pero existen hijos
      Object.values(unidadesMap).forEach(arr => {
        arr.forEach(u => {
          const hijosArr = hijosPorPadre[u['Unidad Organizativa']] || [];
          if ((!u['Unidades que Reportan Directamente'] || !u['Unidades que Reportan Directamente'].trim()) && hijosArr.length) {
            // Agrupar por nombre y mostrar solo una vez, salvo ambigüedad
            const hijosUnicos = {};
            hijosArr.forEach(hijo => {
              if (!hijosUnicos[hijo.nombre]) hijosUnicos[hijo.nombre] = new Set();
              hijosUnicos[hijo.nombre].add(hijo.padre);
            });
            const hijosFormateados = Object.entries(hijosUnicos).map(([nombre, padresSet]) => {
              const padres = Array.from(padresSet);
              if (padres.length > 1 || (nombreCount[nombre] && nombreCount[nombre].size > 1)) {
                // Si hay ambigüedad, mostrar todos los padres
                return padres.map(padre => `${nombre} [Reporta a: ${padre}]`).join(', ');
              } else {
                return nombre;
              }
            });
            u['Unidades que Reportan Directamente'] = Array.from(new Set(hijosFormateados)).join(', ');
            u._autocompletado = true;
            // Marcar si hay algún caso ambiguo
            u._ambiguedad = Object.values(hijosUnicos).some(padresSet => padresSet.size > 1);
            inconsistenciaDetectada = true;
          }
        });
      });
    }
    // Agregar/eliminar funciones
    window.addFuncRow = function(type) {
      const base = unidadesMap[lastSelected][0];
      if (type === 'gen') {
        unidadesMap[lastSelected].push({ ...base, 'Tipo de Función': 'Genérica', 'Descripción': '', 'Producto Final': '' });
      } else {
        unidadesMap[lastSelected].push({ ...base, 'Tipo de Función': 'Específica', 'Descripción': '', 'Producto Final': '', 'Porcentaje Dedicación': '' });
      }
      showUnidad(unidadesMap[lastSelected]);
      compararCSVActualConOriginal && compararCSVActualConOriginal();
    };
    window.deleteFuncRow = function(type, idx) {
      let arr = unidadesMap[lastSelected];
      let filtered = arr.filter(u => {
        if (type === 'gen') return !(u['Tipo de Función'].toLowerCase().includes('gen') && arr.filter(x => x['Tipo de Función'].toLowerCase().includes('gen')).indexOf(u) === idx);
        else return !(u['Tipo de Función'].toLowerCase().includes('espec') && arr.filter(x => x['Tipo de Función'].toLowerCase().includes('espec')).indexOf(u) === idx);
      });
      unidadesMap[lastSelected] = filtered;
      showUnidad(unidadesMap[lastSelected]);
      compararCSVActualConOriginal && compararCSVActualConOriginal();
    };
    // Exportar CSV
    function exportCSV() {
      let rows = [csvHeaders.join(';')];
      Object.values(unidadesMap).forEach(arr => {
        arr.forEach(u => {
          let row = csvHeaders.map(h => (u[h] || ''));
          rows.push(row.join(';'));
        });
      });
      const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'unidades_organizativas_editado.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      // Guardar como original y resetear flag
      originalCSV = rows.join('\n');
      datosModificados = false;
      marcarAdminCambios(false);
    }
    // Alternar modo edición
    document.getElementById('editModeBtn').addEventListener('click', function() {
      editMode = !editMode;
      if (editMode) {
        inconsistenciaDetectada = false;
        autocompletarUnidadesReportan();
        if (inconsistenciaDetectada) {
          alert('Se detectaron y corrigieron inconsistencias en "Unidades que Reportan Directamente". Exporta el archivo para que el ajuste sea permanente. Los campos autocompletados están resaltados.');
        }
      }
      this.classList.toggle('active', editMode);
      this.textContent = editMode ? 'Salir de edición' : 'Entrar en modo edición';
      document.getElementById('exportBtn').style.display = editMode ? '' : 'none';
      showUnidad(unidadesMap[lastSelected]);
      // Al salir de edición, actualizar el árbol SIEMPRE con la memoria actual
      if (!editMode) {
        const treeDiv = document.getElementById('tree-container');
        treeDiv.innerHTML = '';
        treeRoots = buildTree([].concat(...Object.values(unidadesMap)));
        renderTree(treeRoots, treeDiv, selectUnidad, lastSelected);
      }
    });
    document.getElementById('exportBtn').addEventListener('click', exportCSV);
    function selectUnidad(key) {
      showUnidad(unidadesMap[key]);
      lastSelected = key;
      const treeDiv = document.getElementById('tree-container');
      treeDiv.innerHTML = '';
      renderTree(treeRoots, treeDiv, selectUnidad, lastSelected);
    }
    // Mouseover para adminBtn
    const adminBtn = document.getElementById('adminBtn');
    adminBtn.addEventListener('mouseenter', function() {
      if (datosModificados) {
        adminBtn.title = '¡Hay cambios sin exportar! Haz clic en Exportar CSV para guardar.';
      }
    });
    adminBtn.addEventListener('mouseleave', function() {
      if (datosModificados) {
        adminBtn.title = '¡Hay cambios sin exportar! Haz clic para exportar.';
      } else {
        adminBtn.title = '';
      }
    });

    // Al cargar la página, intentar cargar datos desde localStorage
    window.addEventListener('DOMContentLoaded', function() {
      const savedCSV = localStorage.getItem('csvData');
      if (savedCSV) {
        originalCSV = savedCSV;
        const data = parseCSV(savedCSV);
        unidadesMap = groupByUnidad(data);
        allUnidades = Object.keys(unidadesMap).map(k => unidadesMap[k][0]['Unidad Organizativa']);
        treeRoots = buildTree(data);
        lastSelected = '';
        expandedNodes = {};
        const treeDiv = document.getElementById('tree-container');
        treeDiv.innerHTML = '';
        renderTree(treeRoots, treeDiv, selectUnidad, lastSelected);
        document.getElementById('unidad-content').innerHTML = '';
        datosModificados = false;
        marcarAdminCambios(false);
      }
    });

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const csvText = evt.target.result;
        // Limpiar cualquier otro dato relacionado en localStorage
        for (let key in localStorage) {
          if (key.startsWith('csvData') && key !== 'csvData') {
            localStorage.removeItem(key);
          }
        }
        localStorage.setItem('csvData', csvText);
        originalCSV = csvText;
        const data = parseCSV(csvText);
        unidadesMap = groupByUnidad(data);
        allUnidades = Object.keys(unidadesMap).map(k => unidadesMap[k][0]['Unidad Organizativa']);
        treeRoots = buildTree(data);
        lastSelected = '';
        expandedNodes = {};
        const treeDiv = document.getElementById('tree-container');
        treeDiv.innerHTML = '';
        renderTree(treeRoots, treeDiv, selectUnidad, lastSelected);
        document.getElementById('unidad-content').innerHTML = '';
        datosModificados = false;
        marcarAdminCambios(false);
        // Mostrar mensaje de confirmación
        mostrarAlerta('Archivo cargado y datos actualizados correctamente.', 2500);
      };
      reader.readAsText(file);
    });

    // Función para mostrar mensajes de alerta visuales
    function mostrarAlerta(mensaje, duracion, color) {
      const saveIndicator = document.getElementById('saveIndicator');
      saveIndicator.textContent = mensaje;
      saveIndicator.style.background = color || '#2ecc71';
      saveIndicator.classList.add('show');
      setTimeout(() => {
        saveIndicator.classList.remove('show');
      }, duracion || 2000);
    }
    // Admin menu toggle
    document.getElementById('adminBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      const menu = document.getElementById('adminMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });
    document.body.addEventListener('click', function() {
      document.getElementById('adminMenu').style.display = 'none';
    });
    document.getElementById('adminMenu').addEventListener('click', function(e) {
      e.stopPropagation();
    });
    </script>
</body>
</html> 